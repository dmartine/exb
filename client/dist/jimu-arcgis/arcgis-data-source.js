define(["jimu-core"],function(e){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(a,o,function(t){return e[t]}.bind(null,o));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=19)}([function(t,r){t.exports=e},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Map="MAP",e.WebMap="WEB_MAP",e.WebScene="WEB_SCENE",e.MapView="MAP_VIEW",e.SceneView="SCENE_VIEW",e.FeatureLayer="FEATURE_LAYER",e.FeatureLayerView="FEATURE_LAYER_VIEW"}(t.DataSourceTypes||(t.DataSourceTypes={}))},,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(1);t.DataSourceTypes=a.DataSourceTypes;var o=r(4);t.MapDataSource=o.MapDataSource;var n=r(20);t.WebMapDataSource=n.WebMapDataSource;var i=r(21);t.WebSceneDataSource=i.WebSceneDataSource;var u=r(22);t.FeatureLayerDataSource=u.FeatureLayerDataSource;var c=r(24);t.FeatureLayerViewDataSource=c.FeatureLayerViewDataSource;var s=r(25);t.MapViewDataSource=s.MapViewDataSource;var p=r(26);t.SceneViewDataSource=p.SceneViewDataSource;var l=r(5);t.FeatureDataRecord=l.FeatureDataRecord;var d=r(6);t.LayerViewDataSource=d.LayerViewDataSource;var h=function(){function e(){}return e.prototype.createDataSource=function(e){var t=e.dataSourceJson;return t.type===a.DataSourceTypes.Map?new o.MapDataSource(e):t.type===a.DataSourceTypes.WebMap?new n.WebMapDataSource(e):t.type===a.DataSourceTypes.WebScene?new i.WebSceneDataSource(e):t.type===a.DataSourceTypes.FeatureLayer?new u.FeatureLayerDataSource(e):t.type===a.DataSourceTypes.MapView?new s.MapViewDataSource(e):t.type===a.DataSourceTypes.SceneView?new p.SceneViewDataSource(e):t.type===a.DataSourceTypes.FeatureLayerView?new c.FeatureLayerViewDataSource(e):void console.error("Unimplemented data source type.",t.type)},e}();t.ArcGISDataSourceFactory=h},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(1),i=function(e){function t(t){var r=e.call(this,t)||this;return r.type=n.DataSourceTypes.Map,r.isDataSourceSet=!0,r.map=t.map,r}return a(t,e),t.prototype.ready=function(){var e=this;return o.loadArcGISJSAPIModules(["esri/Map","esri/layers/FeatureLayer"]).then(function(t){return e.Map=t[0],e.FeatureLayer=t[1],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()})},t.prototype.fetchSchema=function(){var e=this.getChildDataSources(),t={childSchemas:{}};return e.map(function(r,a){var o=r.getFetchedSchema();t.childSchemas[e[a].layer.id]=o}),Promise.resolve(t)},t.prototype.whenChildDataSourcesCreated=function(){return this.childDataSourcesPromise.then(function(e){return e})},t.prototype.createMap=function(){var e=this;this.map=new this.Map,this.dataSourceJson.layers.forEach(function(t){e.map.layers.add(new e.FeatureLayer(t))})},t.prototype.createChildDataSources=function(){var e=this,t=[];return this.map.layers.toArray().forEach(function(r){e.getJimuChildId(r.id).forEach(function(a){var i=e.dataSourceJson.schema?e.dataSourceJson.schema.childSchemas[a]:null,u=o.Immutable({id:e.getFullChildDataSourceId(a),type:n.DataSourceTypes.FeatureLayer,label:r.title});if(i&&(u=u.set("schema",i)),"feature"===r.type){var c={dataSourceJson:u,layer:r,parentDataSource:e};t.push(e.dataSourceManager.createDataSource(c))}})}),this.setStatus(o.DataSourceStatus.Loaded),this.childDataSourcesPromise=Promise.all(t),this.childDataSourcesPromise},t.prototype.destroy=function(){var e=this;this.getChildDataSources().forEach(function(t){t&&e.dataSourceManager.destroyDataSource(t.id)})},t}(o.AbstractDataSource);t.MapDataSource=i},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t,r,a){void 0===a&&(a=!0);var o=e.call(this)||this;return o.dataSource=r,a?(t.attributes=o.convertOriginDataToData(t.attributes),o.feature=t):o.feature=t,o}return a(t,e),t.prototype.getData=function(){return this.feature.attributes},t.prototype.getOriginData=function(){var e=this.feature.clone();return e.attributes=this.convertDataToOriginData(this.getData()),e},t.prototype.toJson=function(){return this.feature.toJSON()},t.prototype.getId=function(){return this.feature.attributes[this.dataSource.getIdField()]+""},t.prototype.setId=function(e){},t.prototype.getGeometry=function(){return this.feature.geometry.toJSON()},t}(r(0).AbstractDataRecord);t.FeatureDataRecord=o},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.getLayerDataSource=function(){return this.dataSourceManager.getDataSource(this.layerDataSourceId)},t.prototype.getRootViewDataSource=function(){return this.getRootDataSource()},t}(r(0).AbstractDataSource);t.LayerViewDataSource=o},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(1),i=function(e){function t(t){var r=e.call(this,t)||this;(r.isDataSourceSet=!0,r.isChildrenCreatedInBuilder=!1,r.isClickedNoPopUpFeature=!1,r.view=t.view,window.jimuConfig.isInBuilder)&&(window.parent&&window.parent._builderPubsub).publish("view_created",{dataSourceId:r.id,view:r.view});if(window.jimuConfig.isBuilder){var a=window._appWindow&&window._appWindow._dataSourceManager&&window._appWindow._dataSourceManager.getDataSource(r.id);a&&a.view?r.view=a.view:window._builderPubsub.subscribe("view_created",function(e,t){t.dataSourceId===r.id&&r.onViewCreatedInApp(t.view)})}return r}return a(t,e),t.prototype.onViewCreatedInApp=function(e){this.view=e,this.initView(e)},t.prototype.ready=function(){var e=this,t=this.type===n.DataSourceTypes.MapView?"esri/views/MapView":"esri/views/SceneView";return o.loadArcGISJSAPIModules([t]).then(function(t){return e.ViewClass=t[0],e.makeSureOriginDataSource()}).then(function(){return e.view?(e.initView(e.view),e.whenChildDataSourcesCreated()):window.jimuConfig.isBuilder?Promise.resolve({}):void console.error("No View")})},t.prototype.initView=function(e){var t=this;window.jimuConfig.isBuilder?this.isChildrenCreatedInBuilder||(this.isChildrenCreatedInBuilder=!0,this.createChildDataSources()):(e.when(function(){e.on("click",t.onClick.bind(t))}),e.popup.watch("visible",function(r){if(r&&(t.isClickedNoPopUpFeature=!1),!r&&e.popup.selectedFeature&&e.popup.selectedFeature.layer){var a=e.popup.selectedFeature.layer.id;if(!a)return;var o=t.getJimuChildId(a);if(!o||0===o.length)return;if(t.isClickedNoPopUpFeature)return void(t.isClickedNoPopUpFeature=!1);t.clearAllChildernDsSelectRecord()}}),e.popup.watch("selectedFeature",function(e){if(e){var r=String(e.attributes[e.layer.objectIdField]),a=e.layer.id;t.getJimuChildId(a).forEach(function(e){var a=t.dataSourceManager.getDataSource(t.getFullChildDataSourceId(e));if(a)switch(a.type){case n.DataSourceTypes.FeatureLayerView:a.handleFeatureNavigationAtPopUp(r)}})}}),this.createChildDataSources())},t.prototype.onClick=function(e){var t=this,r={x:e.x,y:e.y};this.view.hitTest(r).then(function(e){if(e&&e.results&&0!==e.results.length||t.clearAllChildernDsSelectRecord(),e.results.length){var r=t.getChildDataSources(),a=[];if(r)for(var o=0;o<r.length;o++)a.push(r[o].id);if(e.results.forEach(function(e){var r=e.graphic,o=r.layer.id;r.layer.popupEnabled||(t.isClickedNoPopUpFeature=!0),t.getJimuChildId(o).forEach(function(e){var o=t.getFullChildDataSourceId(e),i=t.dataSourceManager.getDataSource(t.getFullChildDataSourceId(e));if(i)switch(i.type){case n.DataSourceTypes.FeatureLayerView:a.splice(a.indexOf(o),1),i.selectRecordById(String(r.attributes[r.layer.objectIdField]))}})}),a)for(o=0;o<a.length;o++){var i=t.dataSourceManager.getDataSource(a[o]);if(i)switch(i.type){case n.DataSourceTypes.FeatureLayerView:i.selectRecordsByIds([])}}}},function(){t.clearAllChildernDsSelectRecord()})},t.prototype.clearAllChildernDsSelectRecord=function(){var e=this.getChildDataSources();if(e&&e.length>0)for(var t=0;t<e.length;t++){var r=e[t];r&&r.type===n.DataSourceTypes.FeatureLayerView&&r.selectRecordsByIds([])}},t.prototype.whenViewLoaded=function(e){var t=this,r=[];return e.map.layers.toArray().map(function(a){var i;e.whenLayerView(a).toPromise().then(function(e){t.getJimuChildId(a.id).map(function(u){switch(a.type){case"feature":i={dataSourceJson:o.Immutable({id:t.getFullChildDataSourceId(u),label:a.title,type:n.DataSourceTypes.FeatureLayerView,isOutputFromWidget:!0}),view:e,parentDataSource:t,layerDataSourceId:t.getMapDataSource().getChildDataSource(u).id}}if(!i)return null;r.push(t.dataSourceManager.createDataSource(i))})})}),Promise.all(r)},t.prototype.makeSureOriginDataSource=function(){return this.dataSourceJson.originDataSourceId?this.dataSourceManager.getDataSource(this.dataSourceJson.originDataSourceId)?Promise.resolve(this.dataSourceManager.getDataSource(this.dataSourceJson.originDataSourceId)):this.dataSourceManager.createDataSource(this.dataSourceJson.originDataSourceId):(console.error("Please set originDataSourceId for map view data source."),Promise.reject())},t.prototype.whenChildDataSourcesCreated=function(){return this.childDataSourcesPromise.then(function(e){return e})},t.prototype.createChildDataSources=function(){var e=this;return this.setStatus(o.DataSourceStatus.Loading),this.childDataSourcesPromise=this.view.when(function(){return e.whenViewLoaded(e.view)}).then(function(t){return e.setStatus(o.DataSourceStatus.Loaded),t}).toPromise(),this.childDataSourcesPromise},t.prototype.getSchema=function(){var e=this.getMapDataSource();return e&&e.getSchema()},t.prototype.getReversedConfigSchema=function(){var e=this.getMapDataSource();return e&&e.getReversedConfigSchema()},t.prototype.getMapDataSource=function(){return this.dataSourceManager.getDataSource(this.dataSourceJson.originDataSourceId)},t.prototype.destroy=function(){var e=this;if(this.getChildDataSources().filter(function(e){return e}).forEach(function(t){return e.dataSourceManager.destroyDataSource(t.id)}),this.view&&!this.view.destroyed){this.view.graphics&&this.view.graphics.destroyed&&this.view.graphics.destroy(),this.view.container=null,this.view.allLayerViews&&this.view.allLayerViews.destroyed&&this.view.allLayerViews.destroy(),this.view.layerViews&&this.view.layerViews.destroyed&&this.view.layerViews.destroy();var t=this.view.ui;t.specialComponents&&0===t.specialComponents.length&&this.view.destroy(),this.view=null}},t}(o.AbstractDataSource);t.AbstractViewDataSource=i},,,,,,,,,,,,function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(3);t.default=a.ArcGISDataSourceFactory,function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(r(3))},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(1),n=r(4),i=r(0),u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=o.DataSourceTypes.WebMap,t}return a(t,e),t.prototype.ready=function(){var e=this;return i.loadArcGISJSAPIModules(["esri/WebMap","esri/portal/Portal","esri/portal/PortalItem"]).then(function(t){return e.WebMap=t[0],e.Portal=t[1],e.PortalItem=t[2],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()})},t.prototype.createMap=function(){if(this.dataSourceJson.portalUrl){var e=new this.Portal({url:this.dataSourceJson.portalUrl});this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId,portal:e})})}else this.map=new this.WebMap({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){var t=this;return this.childDataSourcesPromise=this.map.when(function(){return e.prototype.createChildDataSources.call(t)}).toPromise(),this.childDataSourcesPromise},t}(n.MapDataSource);t.WebMapDataSource=u},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),n=r(1),i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=n.DataSourceTypes.WebScene,t}return a(t,e),t.prototype.ready=function(){var e=this;return o.loadArcGISJSAPIModules(["esri/WebScene","esri/portal/Portal","esri/portal/PortalItem"]).then(function(t){return e.WebScene=t[0],e.Portal=t[1],e.PortalItem=t[2],e.map||e.createMap(),e.createChildDataSources(),e.whenChildDataSourcesCreated()})},t.prototype.createMap=function(){if(this.dataSourceJson.portalUrl){var e=new this.Portal({url:this.dataSourceJson.portalUrl});this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId,portal:e})})}else this.map=new this.WebScene({portalItem:new this.PortalItem({id:this.dataSourceJson.itemId})});this.map.isFulfilled()||this.map.load()},t.prototype.createChildDataSources=function(){var t=this;return this.childDataSourcesPromise=this.map.when(function(){return e.prototype.createChildDataSources.call(t)}).toPromise()},t}(r(4).MapDataSource);t.WebSceneDataSource=i},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=r(23),u=r(5),c=function(e){function t(t){var r=e.call(this,t)||this;return r.layer=t.layer,r}return a(t,e),t.prototype.ready=function(){var e=this;return n.loadArcGISJSAPIModules(["esri/layers/FeatureLayer"]).then(function(t){e.FeatureLayer=t[0],e.layer||(e.dataSourceJson.url?e.layer=new e.FeatureLayer({url:e.dataSourceJson.url}):e.dataSourceJson.id&&(e.layer=new e.FeatureLayer({portalItem:{id:e.dataSourceJson.id}})))})},t.prototype.doQuery=function(e){var t=this;return this.layer.queryFeatures(e).then(function(e){return e.features.map(function(e){return new u.FeatureDataRecord(e,t)})}).toPromise()},t.prototype.doQueryById=function(e){var t=this;return t.layer.queryFeatures({objectIds:[parseInt(e)],outFields:["*"],returnGeometry:!0}).then(function(e){return e.features.map(function(e){return new u.FeatureDataRecord(e,t)})[0]}).toPromise()},t.prototype.mergeQuery=function(e,t){var r="("+e.where+") and ("+t.where+")";return o({},e,t,{where:r})},t.prototype.getIdField=function(){var e=this.getSchema().layerDefinition,t=e.objectIdField;if(!t){var r=e.fields.find(function(e){return"esriFieldTypeOID"===e.type});r&&(t=r.name)}return t||(t="OBJECTID"),t},t.prototype.load=function(t,r){void 0===r&&(r=!1);var a=this.getAllLayerViewDataSource();if(a&&a.length>0)for(var o=0;o<a.length;o++)a[o].setDefinitionExpressionForLayer(this.getRealQuery(t,"load"));return e.prototype.load.call(this,t,r)},t.prototype.getAllLayerViewDataSource=function(){var e=this.dataSourceManager.getDataSources(),t=Object.keys(e),r=[];if(t&&t.length>0)for(var a=0;a<t.length;a++)e[t[a]].layerDataSourceId===this.id&&r.push(t[a]);if(r&&r.length>0){var o=[];for(a=0;a<r.length;a++)o.push(this.dataSourceManager.getDataSource(r[a]));return o}return[]},t.prototype.fetchSchema=function(){var e=this;return this.layer.load().toPromise().then(function(){var t={layerDefinition:e.layer,fields:{}};return e.parentDataSource&&(t.childId=e.layer.id,t.jimuChildId=e.layer.id),e.layer.fields.forEach(function(r){var a=e.layer.popupTemplate&&e.layer.popupTemplate.fieldInfos&&e.layer.popupTemplate.fieldInfos.find(function(e){return e.fieldName===r.name});a&&(a=a.toJSON()),t.fields[r.name]=n.dataSourceUtils.convertFieldToJimuField(r.toJSON(),a)}),t})},t.prototype.selectRecordById=function(t){e.prototype.selectRecordById.call(this,t);var r=this.getAllLayerViewDataSource();if(r&&r.length>0)for(var a=0;a<r.length;a++)r[a].getSelectedRecordIds().indexOf(t)<0&&r[a].selectRecordById(t)},t.prototype.selectRecordsByIds=function(t){e.prototype.selectRecordsByIds.call(this,t);var r=this.getAllLayerViewDataSource();if(r&&r.length>0)for(var a=0;a<r.length;a++)t&&t.join("")!==r[a].getSelectedRecordIds().join("")&&r[a].selectRecordsByIds(t)},t}(n.AbstractQueriableDataSource);t.FeatureLayerDataSource=c,n.utils.applyMixins(c,[i.LayerDataSource])},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype.getMapDataSource=function(){return this.getRootDataSource()},t.prototype.getLayerViewDataSource=function(){var e=this,t=this.dataSourceManager.getDataSources(),r=Object.keys(t).find(function(r){return t[r].layerDataSourceId===e.id});if(r)return this.dataSourceManager.getDataSource(r)},t}(r(0).AbstractDataSource);t.LayerDataSource=o},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),i=r(6),u=r(3),c=r(5),s=function(e){function t(t){var r=e.call(this,t)||this;return r.getView=function(){var e=r.getRootViewDataSource();return e.type,u.DataSourceTypes.MapView,e.view},r.view=t.view,r.url=r.view.layer.url,r.layerDataSourceId=t.layerDataSourceId,r.getView().popup.watch("selectedFeature",function(e){e&&r.highLightFeatures(r.getSelectedRecordIds().map(function(e){return parseInt(e)}),!0)}),r.getSelectedRecordIds().length>0?r.moveFeatureToCenter(r.getSelectedRecordIds()[0]).then(function(){r.highLightSelectedFeatures()}):r.getLayerDataSource()&&r.getLayerDataSource().getSelectedRecordIds().length>0&&r.moveFeatureToCenter(r.getLayerDataSource().getSelectedRecordIds()[0]).then(function(){r.highLightFeatures(r.getLayerDataSource().getSelectedRecordIds().map(function(e){return parseInt(e)}))},function(e){return console.error(e)}),r}return a(t,e),t.prototype.doQuery=function(e){var t=this;return new Promise(function(r){t.view.updating?(t.updateWatchHandle&&(t.updateWatchHandle.remove(),t.updateWatchHandle=null),t.updateWatchHandle=t.view.watch("updating",function(a){a||t.view.queryFeatures(e).then(function(e){t.records=e.features.map(function(e){return new c.FeatureDataRecord(e,t)}),r(t.records)})})):t.view.queryFeatures(e).then(function(e){t.records=e.features.map(function(e){return new c.FeatureDataRecord(e,t)}),r(t.records)},function(e){console.error(e)})})},t.prototype.doQueryById=function(e){var t={objectIds:[parseInt(e)],returnGeometry:!0};return this.doQuery(t).then(function(e){return e[0]})},t.prototype.mergeQuery=function(e,t){var r="("+e.where+") and ("+t.where+")";return o({},e,t,{where:r})},t.prototype.setDefinitionExpressionForLayer=function(e){this.view.layer.definitionExpression=e.where},t.prototype.highLightSelectedFeatures=function(){var e=this;this.moveFeatureToCenter(this.getSelectedRecordIds()[0]).then(function(){e.highLightFeatures(e.getSelectedRecordIds().map(function(e){return parseInt(e)}))},function(e){return console.error(e)})},t.prototype.highLightFeatures=function(e,t){var r=this;this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,t||this.getView().popup.close()),this.view.when(function(){r.highLightHandle=r.view.highlight(e)})},t.prototype.clearHighLight=function(){this.highLightHandle&&(this.highLightHandle.remove(),this.highLightHandle=null,this.getView().popup.close())},t.prototype.selectRecordById=function(t){e.prototype.selectRecordById.call(this,t),this.getLayerDataSource()&&this.getLayerDataSource().getSelectedRecordIds().indexOf(t)<0&&this.getLayerDataSource().selectRecordById(t),null===t||void 0===t?this.clearHighLight():this.highLightFeatures([parseInt(t)])},t.prototype.selectRecordsByIds=function(t){e.prototype.selectRecordsByIds.call(this,t),this.getLayerDataSource()&&t&&t.join("")!==this.getLayerDataSource().getSelectedRecordIds().join("")&&this.getLayerDataSource().selectRecordsByIds(t),t&&t.length>0?this.highLightFeatures(t.map(function(e){return parseInt(e)})):this.clearHighLight()},t.prototype.handleFeatureNavigationAtPopUp=function(t){var r=this.getLayerDataSource();r&&r.getSelectedRecordIds().join("")!==t&&(e.prototype.selectRecordsByIds.call(this,[t]),r.selectRecordsByIds([t]),this.highLightFeatures([parseInt(t)],!0))},t.prototype.moveFeatureToCenter=function(e){var t=this;return this.doQueryById(e).then(function(r){return r||(t.getLayerDataSource()?t.getLayerDataSource().doQueryById(e):null)}).then(function(r){if(r){var a=t.getCenterPoint(r.feature.geometry),o=t.getRootViewDataSource();return a?(o.type,u.DataSourceTypes.MapView,o.view.goTo(a)):Promise.reject("Does not find center point.")}return Promise.reject("Dose not find feature."+e)})},t.prototype.getCenterPoint=function(e){switch(e.type){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"polyline":return e.extent.center;default:return e&&e.extent?e.extent.center:void 0}},t.prototype.getIdField=function(){return this.getLayerDataSource()&&this.getLayerDataSource().getIdField()},t.prototype.getSchema=function(){return this.getLayerDataSource()&&this.getLayerDataSource().getSchema()},t}(n.AbstractQueriableDataSource);t.FeatureLayerViewDataSource=s,n.utils.applyMixins(s,[i.LayerViewDataSource])},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(1),n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=o.DataSourceTypes.MapView,t}return a(t,e),t}(r(7).AbstractViewDataSource);t.MapViewDataSource=n},function(e,t,r){"use strict";var a=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=r(1),n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=o.DataSourceTypes.SceneView,t}return a(t,e),t}(r(7).AbstractViewDataSource);t.SceneViewDataSource=n}])});
//# sourceMappingURL=arcgis-data-source.js.map