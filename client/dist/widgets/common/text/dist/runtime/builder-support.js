define(["jimu-core","jimu-ui","jimu-for-builder","jimu-for-builder/for-app-inbuilder"],function(e,t,n,o){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=647)}({2:function(t,n){t.exports=e},372:function(e,t){e.exports=o},393:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),r=/\<exp((?!\<exp).)*((?!\<exp).)*\<\/exp\>/gm;t.expressionRegular=r;var i=/\<a((?!\<a).)*((?!\<a).)*\<\/a\>/gm;t.linkRegular=i;var s=/expid="(((?!\<span).)*)\"\>/m;t.expressionIdRegular=s;var a=/id="(.*)\"\starget/m;t.linkIdRegular=a;t.linkHrefRegular=/href="((?!").)*"/m,t.getDataSourceIds=function(e){return void 0===e&&(e=o.Immutable([])),o.Immutable(e.map(function(e){return e.dataSourceId}))},t.getIdsFromHtml=function(e,t){var n="LINK"===t?i:r,o="LINK"===t?a:s,u=[];if(!e)return u;var c=e.match(n);return c?(c.forEach(function(e){var t=e.match(o),n=t&&t[1];n&&u.push(n)}),u):u}},4:function(e,n){e.exports=t},6:function(e,t){e.exports=n},647:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(648);t.default={WidgetInBuilder:o.WidgetInBuilder}},648:function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i=n(372),s=n(6),a=n(393),u=n(4),c=n(649),p={className:"bg-white border shadow rounded",container:"body",placement:"auto",zIndex:51,offset:[0,10],modifiers:{preventOverflow:{enabled:!0,boundariesElement:document&&document.body}}},d={toolbar:!1,autoformat:{link:{trigger:/[\s]/,find:/https?:\/\/[\S]+|(www\.[\S]+)/gi,transform:function(e,t){return t?"http://"+e:e},format:"link"}},clipboard:{matchers:[["img",function(e,t){return{ops:[],length:0}}]]}},f=function(e){function t(t){var n=e.call(this,t)||this;return n.getPligins=function(){var e=n.state.formats,t=n.props,o=t.useDataSources,i=t.widgetState,s=void 0===i?{}:i,u=n.domNode.current;return{formats:r.lodash.assign({},p,{draggable:!0,header:{text:n.nls("textFormat"),onClose:n.onFormatPluginClose},formats:e,open:s&&s.showFormats,reference:u,onChange:n.onPluginChange}),expression:r.lodash.assign({},p,{draggable:!0,header:{text:n.nls("dynamicContent"),onClose:n.onExpressionPluginClose},formats:e,open:s&&s.showExpression,reference:u,dataSourceIds:a.getDataSourceIds(o),onChange:n.onPluginChange})}},n.nls=function(e){var t=n.props.intl;return t?t.formatMessage({id:e,defaultMessage:c.default[e]}):""},n.showExpressionPanel=function(){var e=n.props.widgetId;r.getAppStore().dispatch(r.appActions.widgetStatePropChange(e,"showExpression",!0)),r.getAppStore().dispatch(r.appActions.widgetStatePropChange(e,"showFormats",!1))},n.tryShowExpressionPanel=function(e){(e=e||n.state.formats)&&e[u.TextFormats.EXPRESSION]&&n.showExpressionPanel()},n.onFormatPluginClose=function(){var e=n.props.widgetId;r.getAppStore().dispatch(r.appActions.widgetStatePropChange(e,"showFormats",!1))},n.onExpressionPluginClose=function(){var e=n.props.widgetId;r.getAppStore().dispatch(r.appActions.widgetStatePropChange(e,"showExpression",!1))},n.onPluginChange=function(e,t,o){var r=n.props.config;e===u.TextFormats.EXPRESSION&&n.editWidgetConfig(r.setIn(["expression",o],t)),e===u.TextFormats.LINK&&n.editWidgetConfig(r.setIn(["link",o],t))},n.getExpressionById=function(e){var t=n.props.config.expression;return t&&t[e]},n.getLinkById=function(e){var t=n.props.config.link;return t&&t[e]},n.updateWidgetJson=function(e){var t=n.props,o=t.config,r=t.widgetJson,i=n.getUpdateNeededExpression(e),s=n.getUpdateNeededLink(e);o=o.set("text",e),i&&(o=o.set("expression",i)),s&&(o=o.set("link",s));var a=n.getUseDataSources(o);a&&(r=r.set("useDataSources",a)),r=r.set("config",o),n.setWidegtJsonToAppConfig(r)},n.getUseDataSources=function(e){var t=n.getExpressionUseDataSources(e);if(t)return n.mergeUseDataSourcesWithExpressionDataSources(t)},n.getExpressionUseDataSources=function(e){var t=e.expression,n=void 0===t?{}:t,o=e.link,r=void 0===o?{}:o,i=[];if(Object.keys(n).forEach(function(e){var t=(n[e]||{parts:[]}).parts;i=i.concat(t)}),Object.keys(r).forEach(function(e){var t=((r[e]||{}).expression||{parts:[]}).parts;i=i.concat(t)}),i.length)return s.expressionUtils.getUseDataSourceFromExpParts(i)},n.mergeUseDataSourcesWithExpressionDataSources=function(e){var t=n.props.useDataSources;return t?t.flatMap(function(t){var o=t.dataSourceId,r=n.getUseDataSourceById(e,o);if(!r)return[t.set("fields",[])];var i=r.fields;return[t.set("fields",i)]}):t},n.getUpdateNeededExpression=function(e){var t=a.getIdsFromHtml(e,"EXPRESSION"),o=n.props.config.expression,i=(void 0===o?r.Immutable({}):o).asMutable(),s=Object.keys(i).filter(function(e){return t.indexOf(e)<0});if(s.length)return s.forEach(function(e){delete i[e]}),r.Immutable(i)},n.getUpdateNeededLink=function(e){var t=a.getIdsFromHtml(e,"LINK"),o=n.props.config.link,i=(void 0===o?r.Immutable({}):o).asMutable(),s=Object.keys(i).filter(function(e){return t.indexOf(e)<0});if(s.length)return s.forEach(function(e){delete i[e]}),r.Immutable(i)},n.getUseDataSourceById=function(e,t){return e.flatMap(function(e){return e.dataSourceId!==t?[]:[e]})[0]},n.setWidegtJsonToAppConfig=function(e){i.getAppConfigAction().editWidget(e).exec()},n.editWidgetConfig=function(e){var t=n.props.widgetId;i.getAppConfigAction().editWidgetConfig(t,e).exec()},n.mixinFormatsForLink=function(e){var t=e&&e.link;if(!t)return e;var o=t.id;if(!o)return e;var i=n.getLinkById(o);return e=r.lodash.assign({},e,{link:i})},n.mixinFormatsForExpression=function(e){var t=e&&e.expid?e:void 0;if(!t)return e;var o=t.expid;if(!o)return e;var i=n.getExpressionById(o);return i=r.lodash.assign({},i,{expid:o}),e=r.lodash.assign({},e,{expression:i})},n.onQuillComponentClick=function(){n.tryShowExpressionPanel()},n.onChangeSelection=function(e,t,o){if("user"===t&&e){var r=e?o.getFormat(e):{};r=n.mixinFormatsForLink(r),r=n.mixinFormatsForExpression(r),n.tryShowExpressionPanel(r),n.setState({formats:r})}},n.getLastOps=function(e){for(var t=e&&e.ops||[],n=t.length-1,o=t[n];!o.insert&&n>0;)o=t[--n];return o},n.onQuillChange=function(e,t,o,r){if(n.setState({html:e}),"user"===o){var i=r.getSelection(!1),s=i?r.getFormat(i):{},a=n.getLastOps(t);a&&"\n"===a.insert&&s.expid&&(s={}),s=n.mixinFormatsForLink(s),s=n.mixinFormatsForExpression(s),n.setState({formats:s})}},n.state={html:""},n.domNode=r.React.createRef(),n}return o(t,e),t.prototype.componentDidMount=function(){var e=this.props.config.text;this.setState({html:e})},t.prototype.componentWillUnmount=function(){var e=this.props.config.text,t=this.state.html;t!==e&&this.updateWidgetJson(t)},t.prototype.render=function(){var e=this.props.config.text;return r.React.createElement("div",{ref:this.domNode,className:"w-100 h-100"},r.React.createElement(i.QuillComponent,{className:"w-100 h-100",modules:d,plugins:this.getPligins(),readOnly:!1,onClick:this.onQuillComponentClick,onChange:this.onQuillChange,onChangeSelection:this.onChangeSelection,selallWhenActive:"<p>Click Edit button to edit text</p>"===e,defaultValue:e}))},t}(r.React.PureComponent);t.WidgetInBuilder=r.ReactRedux.connect(function(e,t){return{widgetJson:e.appConfig.widgets[t.widgetId],widgetState:e.widgetsState[t.widgetId]||r.Immutable({})}})(f)},649:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={_widgetLabel:"Text",textFormat:"Text format",dynamicContent:"Dynamic content"}}})});
//# sourceMappingURL=builder-support.js.map