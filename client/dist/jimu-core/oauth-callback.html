<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ArcGIS Rest JS OAuth redirect</title>
  </head>
  <body>
    <script src="./request.umd.min.js"></script>
    <script src="./auth.umd.min.js"></script>
    <script src="./js.cookie.js"></script>
    <script>
      function processAuthentication() {
        let qo = getQueryObject();

        let session = arcgisRest.UserSession.completeOAuth2({
          portal: qo.portal,
          clientId: qo.clientID,
        });
        // localStorage.setItem('__ARCGIS_REST_USER_SESSION__', session.serialize());
        writeCookie(session);

        window.location.href = qo.fromUrl;
      }

      function getQueryObject(){
        var query = window.location.search;
        if (query.indexOf('?') > -1) {
          query = query.substr(1);
        }
        var pairs = query.split('&');
        var queryObject = {};
        for(var i = 0; i < pairs.length; i++){
          var splits = decodeURIComponent(pairs[i]).split('=');
          var v = splits[1];
          queryObject[splits[0]] = splits[1];
        }
        return queryObject;
      }

      function writeCookie(session){
        let i = session.portal.indexOf('/sharing/rest');
        let domain = session.portal.substring('https://'.length, i);
        let parts = domain.split('.');
        let urlKey = parts[0];
        parts.splice(0, 1);
        let customBaseUrl = parts.join('.');
        let esriAuthJson = {
          portalApp: false,
          email: session.username,
          token: session.token,
          // culture: "en-US",
          // region: "WO",
          expires: session.tokenExpires,
          // accountId: "oC086ufSSQ6Avnw2",
          // role: "account_admin",
          // created: 1559636894575,
          // persistent: false,
          // id: "GaSIxAT21wz1Cet2",
          urlKey: urlKey,
          customBaseUrl: customBaseUrl
        }
        Cookies.set('esri_auth', JSON.stringify(esriAuthJson));
      }
      processAuthentication();
    </script>
  </body>
</html>
