define(["jimu-core","jimu-ui"],(function(e,t){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=377)}({100:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Url="url",e.Code="code"}(t.EmbedType||(t.EmbedType={}))},3:function(t,o){t.exports=e},377:function(e,t,o){"use strict";var r,n=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,o=1,r=arguments.length;o<r;o++)for(var n in t=arguments[o])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},s=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(n,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var o,r,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,r&&(n=2&i[0]?r.return:i[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,i[1])).done)return n;switch(r=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var c=o(3),l=o(4),u=o(100),p=o(378),d=o(379),f=function(e){function t(t){var o=e.call(this,t)||this;o.iframeOnLoad=function(e){o.setState({isResetting:!1})},o.iFrameContentRender=function(){var e=o.props.config.embedType,t=o.state.content;return e===u.EmbedType.Code?{srcDoc:t}:e===u.EmbedType.Url?{src:t}:void 0},o.processUrl=function(e){var t,r;if(!e)return e;var n,i=e.toLowerCase();return/https:\/\/vimeo\.com\/.*/.test(i)?"https://player.vimeo.com/video/"+(n=(e=c.urlUtils.removeSearchFromUrl(e)).split("/"))[n.length-1]:/https:\/\/www\.youtube\.com\/watch\?.*v=.*/.test(i)?"https://www.youtube.com/embed/"+(null===(r=null===(t=c.queryString.parseUrl(e))||void 0===t?void 0:t.query)||void 0===r?void 0:r.v):/https:\/\/youtu\.be\/.*/.test(i)?"https://www.youtube.com/embed/"+(n=(e=c.urlUtils.removeSearchFromUrl(e)).split("/"))[n.length-1]:/https:\/\/www\.facebook\.com\/.*\/videos\/.*/.test(i)?"https://www.facebook.com/plugins/video.php?href="+i+"&show_text=0":(o.checkURLFormat(e)||(e="about:blank"),e)},o.checkURLFormat=function(e){if(!e||""===e)return!1;if(!new RegExp("^(([h][t]{2}[p][s])?://)").test(e))return!1;var t=e.indexOf(".");return!(t<0||t===e.length-1)},o.formatMessage=function(e){return o.props.intl.formatMessage({id:e,defaultMessage:p.default[e]})},o.fetchUrl=function(e){return s(o,void 0,Promise,(function(){var t,o;return a(this,(function(r){switch(r.label){case 0:return[4,fetch(e,{method:"get",headers:{"Access-Control-Allow-Origin":"*","Content-Type":"text/json"}}).catch((function(e){}))];case 1:return(t=r.sent())?[4,t.json().catch((function(e){}))]:[2,Promise.resolve(null)];case 2:return o=r.sent(),[2,Promise.resolve(o)]}}))}))},o.isUsedDataSource=function(e){e||(e=o.props);var t=e.useDataSources;return e.useDataSourcesEnabled&&t&&t.length>0},o.onUrlExpResolveChange=function(e){e.isSuccessful?o.setState({content:o.processUrl(e.value),resolveErr:!1}):o.setState({resolveErr:!0})},o.getRecordsFromRepeatedDataSource=function(){var e,t=o.props.useDataSources&&o.props.useDataSources[0]&&o.props.useDataSources[0].dataSourceId;if(t&&o.props.repeatedDataSource){var r=o.props.repeatedDataSource.record;return(e={})[t]=r,e}return null};var r=t.config,n=r.embedType,i=r.embedCode;o.errMessages={unSupportUrl:o.formatMessage("unSupportUrl"),unSupportIframeUrl:o.formatMessage("unSupportIframeUrl")},o.checkUrl=o.checkUrl.bind(o);var l={content:n===u.EmbedType.Url?o.isUsedDataSource()?void 0:o.processUrl(r.staticUrl):i,loadErr:!1,resolveErr:!1};return l.content&&l.content.trim().length>0&&(l.isResetting=!0),o.state=l,o}return n(t,e),t.prototype.componentDidMount=function(){var e=this.props.config.embedType,t=this.state.content;e===u.EmbedType.Url&&this.checkUrl(t)},t.prototype.componentDidUpdate=function(e,t){var o=this,r=this.props.config,n=r.embedCode,i=r.embedType,s=r.staticUrl;if(i!==e.config.embedType){var a=i===u.EmbedType.Url?this.isUsedDataSource()?void 0:this.processUrl(s):n;this.setState({content:a})}else if(i===u.EmbedType.Url){var c=this.isUsedDataSource(),l=this.isUsedDataSource(e);if(!c||c!==l){var p=this.isUsedDataSource()?void 0:this.processUrl(s);this.setState({content:p})}}else e.config.embedCode!==n&&this.setState({content:n});var d=this.state.content,f=t.content;d!==f&&this.setState({isResetting:!!d,loadErr:!1},(function(){i===u.EmbedType.Url&&o.checkUrl(d)}))},t.prototype.checkUrl=function(e){var t,o,r,n=this;if(this.checkURLFormat(e)){var i=null===(r=null===(o=null===(t=c.getAppStore())||void 0===t?void 0:t.getState())||void 0===o?void 0:o.appRuntimeInfo)||void 0===r?void 0:r.appMode;e&&window.jimuConfig.isInBuilder&&i!==c.AppMode.Run&&(e.indexOf("https://www.facebook.com/plugins/video.php?show_text=0&href=")>-1||e.indexOf("https://www.youtube.com/embed/")>-1||e.indexOf("https://player.vimeo.com/video/")>-1?this.setState({loadErr:!1}):this.fetchUrl(window.location.origin+"/check_url?url="+e).then((function(t){var o,r,i,s,a,c,l=!0;if(t&&t.success){var u=t.data,p=null===(o=u)||void 0===o?void 0:o.status;if(p&&p<400){(null===(i=null===(r=u)||void 0===r?void 0:r.headers)||void 0===i?void 0:i["content-security-policy"])&&(l=!1);var d=null===(c=null===(a=null===(s=u)||void 0===s?void 0:s.headers)||void 0===a?void 0:a["x-frame-options"])||void 0===c?void 0:c.toLowerCase();d&&("deny"===d?l=!1:"sameorigin"===d&&(n.isOriginSameAsLocation(e)||(l=!1)))}else l=!1}else l=!1;var f={loadErr:!l};l||(f.isResetting=!1,f.errMessage=n.errMessages.unSupportIframeUrl),n.setState(f)})))}else this.setState({loadErr:!0,errMessage:this.errMessages.unSupportUrl})},t.prototype.isOriginSameAsLocation=function(e){var t=window.location,o=/(\w+:)?(?:\/\/)([\w.-]+)?(?::(\d+))?\/?/.exec(e)||[],r={protocol:o[1]||"",host:o[2]||"",port:o[3]||""},n=function(e){return e.port||{"http:":80,"https:":443}[e.protocol||t.protocol]};return!!(r.protocol&&r.protocol==t.protocol&&r.host&&r.host==t.host&&r.host&&n(r)==n(t))},t.prototype.render=function(){var e,t=this,r=this.state,n=r.isResetting,s=r.loadErr,a=r.errMessage,p=r.resolveErr,d=this.props,f=d.theme,h=d.id,v=d.config,m=v.embedCode,b=v.embedType,y=v.staticUrl,g=v.expression,w=this.props.useDataSourcesEnabled;return(b===u.EmbedType.Code?!m:!y&&!w||w&&!g)?c.React.createElement(l.WidgetPlaceholder,{widgetId:this.props.id,icon:o(380),message:this.formatMessage("embedHint")}):c.React.createElement("div",{style:{width:"100%",height:"100%",position:"relative"},className:"jimu-widget widget-embed"},c.React.createElement("iframe",i({className:"iframe-"+h,style:{width:"100%",height:"100%"},sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-presentation",allowFullScreen:!0,onLoad:this.iframeOnLoad},this.iFrameContentRender(),{frameBorder:"0",ref:function(e){t.ifr=e}})),n&&c.React.createElement("div",{className:"jimu-secondary-loading"}),s&&c.React.createElement("div",{className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,paddingTop:"30%",backgroundColor:f.colors.white}},a),p&&w&&c.React.createElement("div",{className:"mask text-center",style:{position:"absolute",left:0,right:0,top:0,bottom:0,paddingTop:"30%",backgroundColor:f.colors.white}},null===(e=g)||void 0===e?void 0:e.name),c.React.createElement("div",{style:{display:"none"}},w&&b===u.EmbedType.Url&&g&&c.React.createElement("div",null,c.React.createElement(c.ExpressionResolverComponent,{useDataSources:this.props.useDataSources,expression:g,onChange:this.onUrlExpResolveChange}))))},t.versionManager=d.versionManager,t}(c.BaseWidget);t.default=f},378:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={_widgetLabel:"Embed",embedHint:"Embed by URL or code",unSupportUrl:"It's not a valid URL.",unSupportIframeUrl:"Sorry, this content could not be embedded. It may restrict the embedding of content from other sites."}},379:function(e,t,o){"use strict";var r,n=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)});Object.defineProperty(t,"__esModule",{value:!0});var i=o(3),s=o(100),a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.versions=[{version:"1.0.0",description:"The first release.",upgrader:function(e){var t,o,r,n,i=null===(o=null===(t=e)||void 0===t?void 0:t.functionConfig)||void 0===o?void 0:o.embedType,a=null===(n=null===(r=e)||void 0===r?void 0:r.functionConfig)||void 0===n?void 0:n.content;return i?(e=e.set("embedType",i),e=i===s.EmbedType.Url?e.set("staticUrl",a):e.set("embedCode",a)):e=e.set("embedType",s.EmbedType.Url),e=e.without("functionConfig")}}],t}return n(t,e),t}(i.BaseVersionManager);t.versionManager=new a},380:function(e,t){e.exports='<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 1a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1H2zm0-1h12a2 2 0 012 2v12a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zM1 4h14v1H1V4zm1.5-1a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm2 0a.5.5 0 110-1 .5.5 0 010 1zm-.646 9.646a.5.5 0 11-.708.708l-3-3a.5.5 0 010-.708l3-3a.5.5 0 11.708.708L3.207 10l2.647 2.646zm4.292 0L12.793 10l-2.647-2.646a.5.5 0 11.708-.708l3 3a.5.5 0 010 .708l-3 3a.5.5 0 11-.708-.708zM8.982 6.62a.5.5 0 01.354.613l-1.553 5.795a.5.5 0 11-.966-.259L8.37 6.973a.5.5 0 01.612-.354z" fill="#000" fill-rule="nonzero"></path></svg>'},4:function(e,o){e.exports=t}})}));