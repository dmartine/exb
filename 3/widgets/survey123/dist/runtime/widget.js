define(["jimu-core","jimu-ui","jimu-arcgis","esri/tasks/support/Query","esri/geometry/SpatialReference"],(function(e,t,r,n,o){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=603)}({0:function(t,r){t.exports=e},1:function(e,r){e.exports=t},121:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.setQueryObject=function(e){var t=e?e.survey123:"",r=t?decodeURIComponent(t+""):"",n=this._urlParamToJson(r);this.queryObj=n},e.prototype.getSurvey123HostUrl=function(){var e="https://survey123.arcgis.com",t=window.jimuConfig.hostEnv;return this.queryObj&&this.queryObj.env&&["dev","prod","qa","beta"].indexOf(this.queryObj.env)>=0&&(t=this.queryObj.env),"dev"===t&&(e="https://survey123dev.arcgis.com"),"qa"===t&&(e="https://survey123qa.arcgis.com"),"beta"===t&&(e="https://survey123beta.arcgis.com"),e},e.prototype.getSurvey123HostAPIUrl=function(){return this.getSurvey123HostUrl()+"/api/jsapi"},e.prototype.createSurvey=function(e,t,r,n){var o=this;return n=Object.assign({snippet:""},n||{}),Promise.resolve(!0).then((function(){if(!(e&&t&&r&&r.token&&r.username))throw new Error("missing title, tags, username or token")})).then((function(){var i=o.getSurvey123HostUrl()+"/api/survey/create",s={title:e,tags:t.join(","),snippet:n.snippet,thumbnailUrl:n.thumbnailUrl,token:r.token,username:r.username,portalUrl:r.portalUrl||"https://www.arcgis.com"};return fetch(i,{mode:"cors",method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(s)}).then((function(e){if(e.ok)return e.json();throw e}))}))},e.prototype.isPortal=function(e){return!["www.arcgis.com","devext.arcgis.com","qaext.arcgis.com"].find((function(t,r){return-1!==e.indexOf(t)}))},e.prototype.querySurvey=function(e,t){var r=this;return t=Object.assign({isShared:!1,isPublished:!0},t||{}),Promise.resolve(!0).then((function(){if(!e||!e.token||!e.username)throw new Error("missing token or username")})).then((function(){var n=r.getSurvey123HostUrl()+"/api/survey/query",o={isShared:t.isShared,isPublished:t.isPublished,token:e.token,username:e.username,portalUrl:e.portalUrl||"https://www.arcgis.com"};return n=n+"?"+Object.keys(o).map((function(e){return e+"="+o[e]})).join("&"),fetch(n,{mode:"cors",method:"GET"}).then((function(e){if(e.ok)return e.json();throw e}))}))},e.prototype.getSurvey123DesignerUrl=function(e,t){t=Object.assign({},t||{});var r=this.getSurvey123HostUrl()+"/surveys/"+e+"/design?embed=exb";return t.portalUrl&&"https://www.arcgis.com"!==t.portalUrl&&(r+="&portalUrl="+t.portalUrl),("https://survey123dev.arcgis.com"===this.getSurvey123HostUrl()&&!t.portalUrl||"https://www.arcgis.com"===t.portalUrl)&&(r+="&portalUrl="+t.portalUrl),r},e.prototype.getSurvey123WebformUrl=function(e,t){t=Object.assign({queryParams:[]},t||{});var r=this.getSurvey123HostUrl()+"/share/"+e;return t.queryParams.length>0&&(r+="?"+t.queryParams.join("&")),r},e.prototype.flatQuestions=function(e){var t=this,r=[];return e.forEach((function(e){e.questions?"esriQuestionTypeRepeat"!==e.type&&(r=r.concat(t.flatQuestions(e.questions))):r.push(e)})),r},e.prototype.getSurveyQuestionFields=function(e,t){var r=this;return Promise.resolve(!0).then((function(){if(!e||!t||!t.token)throw new Error("missing surveyItemId or token")})).then((function(){var n=r.getSurvey123HostUrl()+"/api/survey/"+e+"/form",o={token:t.token};return n=n+"?"+Object.keys(o).map((function(e){return e+"="+o[e]})).join("&"),fetch(n,{mode:"cors",method:"GET"}).then((function(e){if(e.ok)return e.json();throw e}))})).then((function(e){var t=[];e&&e.questions&&e.questions.length>0&&r.flatQuestions(e.questions).forEach((function(e){var r=(e.type+"").replace("esriQuestionType","");(e.fieldName||["geopoint","polyline","polygon"].indexOf(r.toLowerCase())>=0)&&t.push({name:e.fieldName||e.name,label:e.label})}));return t}))},e.prototype._urlParamToJson=function(e){var t=this;if(!e)return null;var r=(e+="").split(";");if(r.length<2&&e.split(":").length<2)return e.split(",").length>1?e.split(","):e;var n={};return r.forEach((function(e){var r=(e+"").split(":");if(r.length>1){var o=r[0],i=(Array.isArray(r.slice(1))?r.slice(1):[]).join(":");i.length&&"{"===i[0]&&(i=t._stringToJson(i)),"string"==typeof i&&i.split(",").length>1&&(i=i.split(",")),n[o]=i}})),n},e.prototype._stringToJson=function(e){var t=e;try{t=JSON.parse(e)}catch(r){t=e}return t},e}();t.Survey123Service=n,t.survey123Service=new n},4:function(e,t){e.exports=r},44:function(e,t){e.exports=n},603:function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),s=r(0),a=r(1),u=r(4),l=r(121),c=r(604),p=r(605),d=r(44),h=r(606),v=function(e){function t(t){var n=e.call(this,t)||this;return n.API={Survey123WebForm:null},n.iconSurvey123=r(607),n.state={featureLayerViewDS:null},n._dsManager=i.DataSourceManager.getInstance(),n._isMapViewAddedClickEvent=!1,n.loadSurveyAPI=function(){var e=l.survey123Service.getSurvey123HostAPIUrl();return n.API.Survey123WebForm?Promise.resolve(n.API.Survey123WebForm):s.moduleLoader.loadModule(e).then((function(e){return n.API=e,e}))},n.updateDomId=function(){return n.domId="survey_container_"+(new Date).getTime(),n.domId},n.onActiveViewChange=function(e){e&&e.view&&(n._mapView=e.view,n._mapView.when((function(){n._mapView.on("click",n.onMapClick)})))},n.onMapClick=function(e){n._mapView.hitTest(e).then((function(e){e.results.length&&e.results.forEach((function(e){var t=e.graphic,r=t.layer.id;if(n.props.useDataSources[0].rootDataSourceId+"-"+r===n.props.useDataSources[0].dataSourceId){var o=t.layer,i=o.objectIdField||"objectid",s=new d({where:i+" = "+t.attributes[i],outFields:["*"],returnGeometry:!0,outSpatialReference:new h({wkid:4326})});o.queryFeatures(s).then((function(e){e.features&&e.features[0]&&n.featureLayerViewHandler(e.features[0])}))}}))}))},n.isDsConfigured=function(){return!(!n.props.useDataSources||1!==n.props.useDataSources.length||!n.props.config.activeLinkData)},n.doQuery=function(e){var t={geometry:e,spatialRelationship:"intersects",returnGeometry:!0};n.getUsedDataSource().getStatus()!==i.DataSourceStatus.Loading&&n.getUsedDataSource().load(t)},n.dataRender=function(e){return e.type===u.DataSourceTypes.WebMap&&n.mapViewHandler(e),e.type===u.DataSourceTypes.FeatureLayer&&n.featureLayerViewHandler(null,e),s.jsx("div",null)},n.checkWebformOptionChanged=function(e){var t=n._formOption;return!Object.is(t,e)&&(!(t||!e)||(t.surveyItemId!==e.surveyItemId||t.portalUrl!==e.portalUrl||t.token!==e.token||t.surveyStatusCode!==e.surveyStatusCode||(t.hideElements?t.hideElements.asMutable():[]).sort().join(",")!==(e.hideElements?e.hideElements.asMutable():[]).sort().join(",")))},n.updateStyle=function(){if("safari"===(window.jimuUA.browser?(window.jimuUA.browser.name+"").toLowerCase():"")){var e=document.querySelector("#"+n.domId);e.style.cssText="overflow-y: auto;",e.closest(".widget-content").style.cssText="position: absolute;"}},n.getClientId(),n.listenSurvey123WebformEvent(),n}return o(t,e),t.prototype.componentDidMount=function(){l.survey123Service.setQueryObject(this.props.queryObject),this.loadSurveyAPI()},t.prototype.getUsedDataSource=function(){var e=this.props.useDataSources,t=null;if(e&&e.length>0){var r=e[0].dataSourceId;t=this._dsManager.getDataSource(r)}return t},t.prototype.mapViewHandler=function(e){var t=this;if(e&&e.view&&!1===this._isMapViewAddedClickEvent){var r=e.view;r.on("click",(function(e){var n=r.toMap({x:e.x,y:e.y});if(n){var o=n.latitude,i=n.longitude;t.postMessageToSurvey123Webform({event:"survey123:onDrawEnd",data:{x:i,y:o}})}})),this._isMapViewAddedClickEvent=!0}},t.prototype.featureLayerViewHandler=function(e,t){var r=null;if(e)r=e;else if(t&&t.getSelectedRecords()){var n=t.getSelectedRecords();r=n>0?n[0]:null}if(this.props.config.activeLinkData&&this.props.config.fieldQuestionMapping){var o=r.attributes||{},i={},s={},a=!1;this.props.config.fieldQuestionMapping.forEach((function(e){var t=e.field,n=e.question;if("geometry"===t){a=!0;var u=r.geometry;!u||!u.y&&0!==u.y||!u.x&&0!==u.x||(s={x:u.x,y:u.y})}else{var l=o[t];i[n]=l||""}})),i&&this.webform.setQuestionValue(i),a&&this.webform.setGeopoint(s)}},t.prototype.listenSurvey123WebformEvent=function(){var e=this,t=function(t){if(t&&t.data){var r=void 0;try{r="string"==typeof t.data?JSON.parse(t.data):t.data&&t.data.payload?"string"==typeof t.data.payload?JSON.parse(t.data.payload):t.data.payload:t.data}catch(e){console.error(e)}var n=r.event,o=r.data;"survey123:onDrawPoint"===n&&e.onDrawPoint(o),"survey123:onFormLoaded"===n&&"survey123:onFormLoaded"===n&&r.contentHeight,"survey123:onSubmitted"===n&&console.log("survey123:onSubmitted!",o)}};window.addEventListener?window.addEventListener("message",t,!1):window.attachEvent("onmessage",t)},t.prototype.getClientId=function(){var e,t,r=i.SessionManager.getInstance().getMainSession();this._clientId="survey123hub",r&&r.clientId&&"experienceBuilder"!==r.clientId?this._clientId=r.clientId:(null===(t=null===(e=i.getAppStore().getState().appConfig)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.clientId)&&(this._clientId=i.getAppStore().getState().appConfig.attributes.clientId)},t.prototype.onDrawPoint=function(e){console.log("start draw point"),this._mapViewDSFromFeatureLayerView&&this.mapViewHandler(this._mapViewDSFromFeatureLayerView)},t.prototype.postMessageToSurvey123Webform=function(e){this.survey123webform&&this.survey123webform.contentWindow?this.survey123webform.contentWindow.postMessage(JSON.stringify(e),"*"):console.log("cannot find survey123webform iframe contentWindow!")},t.prototype.buildWebFormConfig=function(){var e=this.props.config,t={clientId:this._clientId||"survey123hub",container:this.domId||this.updateDomId(),itemId:e.surveyItemId,autoRefresh:3,isDebugMode:!1},r=e.portalUrl||this.props.portalUrl||"https://www.arcgis.com";"https://www.arcgis.com"===r&&(t.portalUrl=r);var n=this.props.token;n&&(t.portalUrl=r,t.token=n);var o=e.hides||i.Immutable(["navbar","header","description","footer","theme"]);o.length>0&&(t.hideElements=o);var s=e.defaultValue;s&&"object"==typeof s&&null!=s&&(t.defaultValue=s);var a=this.props.stateProps?this.props.stateProps.surveyStatusCode:0;return a&&(t.surveyStatusCode=a),t},t.prototype.getWebformUrl=function(){var e=this.props.config,t=e.surveyItemId,r=e.portalUrl||this.props.portalUrl||"https://www.arcgis.com",n=null;if(t){var o=[];"https://www.arcgis.com"!==r&&o.push("portalUrl="+r),"https://survey123dev.arcgis.com"===l.survey123Service.getSurvey123HostUrl()&&"https://www.arcgis.com"===r&&o.push("portalUrl="+r);var i=e.embeds||[];-1===i.indexOf("jsapi")&&(i=i.concat(["jsapi"])),-1===i.indexOf("onSubmitted")&&(i=i.concat(["onSubmitted"])),i.length>0&&o.push("embed="+i.join(","));var s=e.hides||["navbar","header","description","footer","theme"];s.length>0&&o.push("hide="+s.join(","));var a=e.defaultValue;a&&"object"==typeof a&&null!=a&&Object.keys(a).forEach((function(e){o.push("field:"+e+"="+a[e])}));var u=e.open||"web";u&&"web"!==u&&-1!==["web","menu","native"].indexOf(u)&&o.push("open="+u);var c=this.props.token;c&&o.push("token="+c),o.push("version=latest"),o.push("autoRefresh=3"),n=l.survey123Service.getSurvey123WebformUrl(t,{queryParams:o})}return n},t.prototype.renderDS=function(){var e=this,t=null,r=null,n=this.buildWebFormConfig();this.isDsConfigured()&&(t=this.props.useDataSources[0].dataSourceId,r=this.props.useDataSources[0].rootDataSourceId);var o=this.checkWebformOptionChanged(n);(this._formOption=n,!this.getWebformUrl()||this.webform&&!o)||(document.querySelector("#"+this.domId)&&(document.querySelector("#"+this.domId).innerHTML="",this.webform=null),this.loadSurveyAPI().then((function(){return e.webform=new e.API.Survey123WebForm(n),e.updateStyle(),!0})));return t&&r&&this.isDsConfigured()?s.jsx(u.JimuMapViewComponent,{useMapWidgetIds:this.props.useMapWidgetIds,onActiveViewChange:this.onActiveViewChange}):s.jsx("div",null)},t.prototype.render=function(){var e;return l.survey123Service.setQueryObject(this.props.queryObject),this.getWebformUrl()?(this.domId||this.updateDomId(),e=s.jsx("div",{className:"survey123__webform"},s.jsx("div",{className:"embed-container",id:this.domId}))):e=s.jsx("div",{className:"survey123__noSurvey"},s.jsx(a.WidgetPlaceholder,{icon:this.iconSurvey123,message:this.props.intl.formatMessage({id:"_widgetLabel",defaultMessage:p.default._widgetLabel}),widgetId:""})),s.jsx("div",{css:c.getStyle(this.props.theme),className:"survey123"},e,this.renderDS())},t}(i.BaseWidget);t.default=v},604:function(e,t,r){"use strict";var n=this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};Object.defineProperty(t,"__esModule",{value:!0});var o,i=r(0);t.getStyle=function(e){return i.css(o||(o=n(["\n    &.survey123{\n        width: 100%;\n        height: 100%;\n        overflow: auto;\n        \n        .title{\n            font-weight: bold;\n        }\n    \n        .survey123__noSurvey{\n            width:100%;\n            height:100%;\n            text-align:center;\n        }\n    \n        .survey123__webform{\n            width:100%; \n            height:100%;\n\n            .embed-container {\n                position: relative; \n                height: 100%;\n                // padding-bottom:80%; \n                width: 100%;\n            } \n            \n            .embed-container iframe, \n            .embed-container object, \n            .embed-container iframe{\n                position: absolute; \n                top: 0; \n                left: 0; \n                width: 100%; \n                height: 100%;\n                border: 0px; \n            } \n            small{\n                position: absolute; \n                z-index: 40; \n                bottom: 0; \n                margin-bottom: -15px;\n            }\n        }    \n    }\n  "],["\n    &.survey123{\n        width: 100%;\n        height: 100%;\n        overflow: auto;\n        \n        .title{\n            font-weight: bold;\n        }\n    \n        .survey123__noSurvey{\n            width:100%;\n            height:100%;\n            text-align:center;\n        }\n    \n        .survey123__webform{\n            width:100%; \n            height:100%;\n\n            .embed-container {\n                position: relative; \n                height: 100%;\n                // padding-bottom:80%; \n                width: 100%;\n            } \n            \n            .embed-container iframe, \n            .embed-container object, \n            .embed-container iframe{\n                position: absolute; \n                top: 0; \n                left: 0; \n                width: 100%; \n                height: 100%;\n                border: 0px; \n            } \n            small{\n                position: absolute; \n                z-index: 40; \n                bottom: 0; \n                margin-bottom: -15px;\n            }\n        }    \n    }\n  "])))}},605:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={_widgetLabel:"Survey"}},606:function(e,t){e.exports=o},607:function(e,t){e.exports='<svg viewBox="0 0 15 16" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero"><path d="M2 10.5v.5-2 .5h1v1H2v.5-2 1.5zm0-4V7 5v.5h1v1H2V7 5v1.5zM2 13h1v1a1 1 0 001 1h9a1 1 0 001-1V2a1 1 0 00-1-1H4a1 1 0 00-1 1v1H2V2a2 2 0 012-2h9a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2v-1zm0 0h1v1a1 1 0 001 1h9a1 1 0 001-1V2a1 1 0 00-1-1H4a1 1 0 00-1 1v1H2V2a2 2 0 012-2h9a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2v-1zm10.071-6.464l-.707-.708-2.828 2.829L7.12 7.243l-.707.707 2.122 2.121 3.535-3.535zm.707.707l-3.535 3.535a1 1 0 01-1.415 0l-2.12-2.121a1 1 0 010-1.414l.706-.707a1 1 0 011.414 0l.708.707 2.12-2.122a1 1 0 011.415 0l.707.707a1 1 0 010 1.415z"></path><path d="M1.5 3.5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1zm0 5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1zm0 5v1h2v-1h-2zm0-1h2a1 1 0 011 1v1a1 1 0 01-1 1h-2a1 1 0 01-1-1v-1a1 1 0 011-1z"></path></g></svg>'}})}));